services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: homelab-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    networks:
      - homelab-network
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: homelab-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - GLANCES_URL=http://host.docker.internal:61208
      - DB_PATH=/app/data/dashboard.db
      - CONFIG_PATH=/app/data/config.json
      - PORTFOLIO_API_URL=http://host.docker.internal:3000
      - PORTFOLIO_PASSWORD=admin
      - JWT_SECRET=${JWT_SECRET:-homelab-dashboard-change-me}
      - STALWART_URL=http://stalwart:8080
      - STALWART_ADMIN_USER=${STALWART_ADMIN_USER:-admin}
      - STALWART_ADMIN_PASSWORD=${STALWART_ADMIN_PASSWORD:-}
      - MAIL_WEBHOOK_SECRET=${MAIL_WEBHOOK_SECRET:-homelab-mail-webhook-secret}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - homelab-data:/app/data
    networks:
      - homelab-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  nginx:
    image: nginx:alpine
    container_name: homelab-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - homelab-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - frontend
      - backend

  stalwart:
    image: stalwartlabs/stalwart:latest
    container_name: homelab-stalwart
    restart: unless-stopped
    hostname: mail.mas0n1x.online
    volumes:
      - stalwart-data:/opt/stalwart
    ports:
      - "25:25"
      - "587:587"
      - "465:465"
      - "143:143"
      - "993:993"
    networks:
      - homelab-network

  # Cloudflare Tunnel (uncomment to enable public access)
  # 1. Create a tunnel at https://one.dash.cloudflare.com -> Networks -> Tunnels
  # 2. Copy the tunnel token to .env as CLOUDFLARE_TUNNEL_TOKEN
  # 3. Add a public hostname pointing to http://nginx:80
  # 4. Uncomment the service below and run: docker compose up -d cloudflared
  #
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: homelab-cloudflared
  #   restart: unless-stopped
  #   command: tunnel --no-autoupdate run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
  #   networks:
  #     - homelab-network
  #   depends_on:
  #     - nginx

networks:
  homelab-network:
    driver: bridge

volumes:
  homelab-data:
  stalwart-data:
